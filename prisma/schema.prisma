// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// 1. Product (商品/裝備) - 支援 RPG 數值與複雜 JSON
// ==============================
model Product {
  id          String   @id @default(uuid())
  title       String   
  description String?  
  brand       String?  
  
  price       Int      
  stock       Int      @default(0) 
  sku         String?  @unique 
  
  isPublished Boolean  @default(true) 
  
  category    String   @default("Uncategorized")

  // --- 複雜資料結構 (JSONB) ---
  ribbons     String[] 
  options     Json?    
  sections    Json?    

  images      Json?    
  videos      Json?

  rarity      String   @default("N")
  
  def         Int      @default(0)
  agi         Int      @default(0)
  res         Int      @default(0)
  
  rpgDetails  Json?    
  
  pricingDetail Json?    
  preOrder    Json?    
  
  seo         Json?    

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- 關聯 ---
  orderItems  OrderItem[]
  cartItems   CartItem[]
  wishlistedBy WishlistItem[]
}

// ==============================
// 2. User (使用者/冒險者) - 支援個人檔案與公會數據
// ==============================
model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  password             String
  role                 Role      @default(USER)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  
  // --- Wallet ---
  points               Int       @default(0)

  // --- Identity ---
  realName             String?   
  codename             String?   
  phone                String?
  avatar               String?   
  
  // --- Guild Stats ---
  class                String    @default("NOVICE")
  rankTitle            String    @default("Iron Rookie")
  level                Int       @default(1)
  exp                  Int       @default(0)
  
  // --- Preferences ---
  marketingConsent     Boolean   @default(false)
  preferredActivities  String[]

  // --- 關聯 ---
  addresses            Address[]
  orders               Order[]
  cart                 Cart?
  coupons              UserCoupon[]
  userQuests           UserQuest[]
  achievements         UserAchievement[] 
  wishlist             WishlistItem[]    
  bookmarks            UserBookmark[]    
}

enum Role {
  USER
  ADMIN
  MERCHANT
}

// ==============================
// 3. Logistics (物流與地址)
// ==============================
model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  recipient String
  phone     String
  city      String
  district  String
  detail    String
  
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
}

model Order {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status    OrderStatus @default(PENDING)
  statusHistory Json?

  total     Int         @default(0)
  pricingSummary Json?

  shippingInfo Json?

  paymentInfo  Json?

  rpgAnalytics Json?
  
  items     OrderItem[]
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  completedAt DateTime?
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  price     Int
  quantity  Int     @default(1)

  productSnapshot Json?
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELLED
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique 
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]
  
  updatedAt DateTime   @updatedAt 
}

model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  quantity  Int     @default(1) 
}

model WishlistItem {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  addedAt   DateTime @default(now())
  
  @@unique([userId, productId])
}

// ==============================
// 4. Marketing (優惠券)
// ==============================
model Coupon {
  id          String      @id @default(uuid())
  code        String      @unique
  description String
  discount    Int
  expiresAt   DateTime?
  
  users       UserCoupon[]
}

model UserCoupon {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponId   String
  coupon     Coupon   @relation(fields: [couponId], references: [id])
  
  isUsed     Boolean  @default(false)
  obtainedAt DateTime @default(now())
}

// ==============================
// 5. Gamification (成就與任務)
// ==============================
model Achievement {
  id          String   @id @default(uuid())
  title       String
  description String
  icon        String
  condition   Json?
  
  users       UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  
  unlockedAt    DateTime    @default(now())

  @@unique([userId, achievementId])
}

model Quest {
  id           String      @id @default(uuid())

  type         QuestType   @default(MAIN)
  isActive     Boolean     @default(true)
  repeatable   Boolean     @default(false)
  
  displayInfo  Json        

  objectives   Json        

  rewards      Json        

  constraints  Json?       

  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime    @default(now())

  userQuests   UserQuest[]
}

enum QuestType {
  MAIN
  DAILY
  EVENT
}

model UserQuest {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  questId     String
  quest       Quest       @relation(fields: [questId], references: [id])

  status      QuestStatus @default(ONGOING)
  progress    Int         @default(0)
  progressDetail Json?
  
  acceptedAt  DateTime    @default(now())
  completedAt DateTime?
}

enum QuestStatus {
  ONGOING
  COMPLETED
  CLAIMED
  FAILED
}

// ==============================
// 6. Content (文章與收藏)
// ==============================
model Article {
  id          String   @id @default(uuid())
  slug        String   @unique
  isPublished Boolean  @default(true)
  
  title       String
  category    String   @default("GENERAL")
  
  subtitle    String?
  coverImage  String?
  authorInfo  Json?

  rpgMetadata Json?    

  contentBody Json?    

  linkedProducts Json? 

  location    Json?    

  views       Int      @default(0)
  likes       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  bookmarks   UserBookmark[]
}

model UserBookmark {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, articleId]) 
}